/* automatically generated by JSCoverage - do not edit */
if (typeof _$jscoverage === 'undefined') _$jscoverage = {};
if (! _$jscoverage['feo.js']) {
  _$jscoverage['feo.js'] = [];
  _$jscoverage['feo.js'][2] = 0;
  _$jscoverage['feo.js'][15] = 0;
  _$jscoverage['feo.js'][16] = 0;
  _$jscoverage['feo.js'][19] = 0;
  _$jscoverage['feo.js'][20] = 0;
  _$jscoverage['feo.js'][21] = 0;
  _$jscoverage['feo.js'][25] = 0;
  _$jscoverage['feo.js'][29] = 0;
  _$jscoverage['feo.js'][30] = 0;
  _$jscoverage['feo.js'][34] = 0;
  _$jscoverage['feo.js'][35] = 0;
  _$jscoverage['feo.js'][36] = 0;
  _$jscoverage['feo.js'][37] = 0;
  _$jscoverage['feo.js'][40] = 0;
  _$jscoverage['feo.js'][41] = 0;
  _$jscoverage['feo.js'][50] = 0;
  _$jscoverage['feo.js'][51] = 0;
  _$jscoverage['feo.js'][62] = 0;
  _$jscoverage['feo.js'][63] = 0;
  _$jscoverage['feo.js'][65] = 0;
  _$jscoverage['feo.js'][71] = 0;
  _$jscoverage['feo.js'][72] = 0;
  _$jscoverage['feo.js'][73] = 0;
  _$jscoverage['feo.js'][74] = 0;
  _$jscoverage['feo.js'][75] = 0;
  _$jscoverage['feo.js'][78] = 0;
  _$jscoverage['feo.js'][79] = 0;
  _$jscoverage['feo.js'][80] = 0;
  _$jscoverage['feo.js'][85] = 0;
  _$jscoverage['feo.js'][87] = 0;
  _$jscoverage['feo.js'][88] = 0;
  _$jscoverage['feo.js'][90] = 0;
  _$jscoverage['feo.js'][91] = 0;
  _$jscoverage['feo.js'][92] = 0;
  _$jscoverage['feo.js'][97] = 0;
  _$jscoverage['feo.js'][98] = 0;
  _$jscoverage['feo.js'][99] = 0;
  _$jscoverage['feo.js'][100] = 0;
  _$jscoverage['feo.js'][108] = 0;
  _$jscoverage['feo.js'][109] = 0;
  _$jscoverage['feo.js'][118] = 0;
  _$jscoverage['feo.js'][119] = 0;
  _$jscoverage['feo.js'][127] = 0;
  _$jscoverage['feo.js'][128] = 0;
  _$jscoverage['feo.js'][130] = 0;
  _$jscoverage['feo.js'][134] = 0;
  _$jscoverage['feo.js'][135] = 0;
  _$jscoverage['feo.js'][137] = 0;
  _$jscoverage['feo.js'][138] = 0;
  _$jscoverage['feo.js'][139] = 0;
  _$jscoverage['feo.js'][142] = 0;
  _$jscoverage['feo.js'][143] = 0;
  _$jscoverage['feo.js'][144] = 0;
  _$jscoverage['feo.js'][149] = 0;
  _$jscoverage['feo.js'][151] = 0;
  _$jscoverage['feo.js'][152] = 0;
  _$jscoverage['feo.js'][154] = 0;
  _$jscoverage['feo.js'][155] = 0;
  _$jscoverage['feo.js'][156] = 0;
  _$jscoverage['feo.js'][161] = 0;
  _$jscoverage['feo.js'][162] = 0;
  _$jscoverage['feo.js'][163] = 0;
  _$jscoverage['feo.js'][170] = 0;
  _$jscoverage['feo.js'][171] = 0;
  _$jscoverage['feo.js'][174] = 0;
  _$jscoverage['feo.js'][175] = 0;
  _$jscoverage['feo.js'][176] = 0;
  _$jscoverage['feo.js'][178] = 0;
  _$jscoverage['feo.js'][183] = 0;
  _$jscoverage['feo.js'][184] = 0;
  _$jscoverage['feo.js'][185] = 0;
  _$jscoverage['feo.js'][187] = 0;
  _$jscoverage['feo.js'][188] = 0;
  _$jscoverage['feo.js'][189] = 0;
  _$jscoverage['feo.js'][191] = 0;
  _$jscoverage['feo.js'][192] = 0;
  _$jscoverage['feo.js'][194] = 0;
  _$jscoverage['feo.js'][195] = 0;
  _$jscoverage['feo.js'][196] = 0;
  _$jscoverage['feo.js'][198] = 0;
  _$jscoverage['feo.js'][199] = 0;
  _$jscoverage['feo.js'][203] = 0;
  _$jscoverage['feo.js'][207] = 0;
  _$jscoverage['feo.js'][208] = 0;
  _$jscoverage['feo.js'][214] = 0;
  _$jscoverage['feo.js'][215] = 0;
  _$jscoverage['feo.js'][221] = 0;
  _$jscoverage['feo.js'][222] = 0;
  _$jscoverage['feo.js'][224] = 0;
  _$jscoverage['feo.js'][228] = 0;
  _$jscoverage['feo.js'][229] = 0;
  _$jscoverage['feo.js'][230] = 0;
  _$jscoverage['feo.js'][232] = 0;
  _$jscoverage['feo.js'][233] = 0;
  _$jscoverage['feo.js'][235] = 0;
  _$jscoverage['feo.js'][236] = 0;
  _$jscoverage['feo.js'][237] = 0;
  _$jscoverage['feo.js'][242] = 0;
  _$jscoverage['feo.js'][247] = 0;
  _$jscoverage['feo.js'][248] = 0;
  _$jscoverage['feo.js'][254] = 0;
  _$jscoverage['feo.js'][255] = 0;
  _$jscoverage['feo.js'][256] = 0;
  _$jscoverage['feo.js'][258] = 0;
  _$jscoverage['feo.js'][259] = 0;
  _$jscoverage['feo.js'][260] = 0;
  _$jscoverage['feo.js'][264] = 0;
  _$jscoverage['feo.js'][267] = 0;
  _$jscoverage['feo.js'][268] = 0;
  _$jscoverage['feo.js'][270] = 0;
  _$jscoverage['feo.js'][277] = 0;
  _$jscoverage['feo.js'][282] = 0;
  _$jscoverage['feo.js'][283] = 0;
  _$jscoverage['feo.js'][286] = 0;
  _$jscoverage['feo.js'][287] = 0;
  _$jscoverage['feo.js'][290] = 0;
  _$jscoverage['feo.js'][291] = 0;
  _$jscoverage['feo.js'][297] = 0;
  _$jscoverage['feo.js'][299] = 0;
  _$jscoverage['feo.js'][300] = 0;
  _$jscoverage['feo.js'][302] = 0;
  _$jscoverage['feo.js'][304] = 0;
  _$jscoverage['feo.js'][306] = 0;
  _$jscoverage['feo.js'][308] = 0;
  _$jscoverage['feo.js'][316] = 0;
  _$jscoverage['feo.js'][317] = 0;
  _$jscoverage['feo.js'][320] = 0;
  _$jscoverage['feo.js'][322] = 0;
  _$jscoverage['feo.js'][323] = 0;
  _$jscoverage['feo.js'][324] = 0;
  _$jscoverage['feo.js'][325] = 0;
  _$jscoverage['feo.js'][327] = 0;
  _$jscoverage['feo.js'][330] = 0;
  _$jscoverage['feo.js'][332] = 0;
  _$jscoverage['feo.js'][333] = 0;
  _$jscoverage['feo.js'][334] = 0;
  _$jscoverage['feo.js'][335] = 0;
  _$jscoverage['feo.js'][338] = 0;
  _$jscoverage['feo.js'][342] = 0;
  _$jscoverage['feo.js'][343] = 0;
  _$jscoverage['feo.js'][344] = 0;
}
_$jscoverage['feo.js'][2]++;
var jsdom = require("jsdom"), async = require("async"), request = require("request"), fs = require("fs"), path = require("path"), compressor = require("node-minify"), htmlMinifier = require("html-minifier"), crypto = require("crypto"), url = require("url"), wrench = require("wrench"), _ = require("underscore");
_$jscoverage['feo.js'][15]++;
exports.isLocal = (function (target) {
  _$jscoverage['feo.js'][16]++;
  return /^http/.test(target)? false: true;
});
_$jscoverage['feo.js'][19]++;
exports.resolve = (function (root, base, target) {
  _$jscoverage['feo.js'][20]++;
  if (this.isLocal(base)) {
    _$jscoverage['feo.js'][21]++;
    return ! this.isLocal(target)? url.resolve(base, target): /^\//.test(target)? path.join(root, target): path.resolve(path.dirname(base), target);
  }
  else {
    _$jscoverage['feo.js'][25]++;
    return url.resolve(base, target);
  }
});
_$jscoverage['feo.js'][29]++;
exports.init = (function (config) {
  _$jscoverage['feo.js'][30]++;
  var dist = config.dist, distFiles = [], i, log = config.log === undefined? true: config.log;
  _$jscoverage['feo.js'][34]++;
  log && console.log("Cleaning dist : ");
  _$jscoverage['feo.js'][35]++;
  log && console.log("  " + dist);
  _$jscoverage['feo.js'][36]++;
  fs.existsSync(dist) && wrench.rmdirSyncRecursive(dist) && fs.rmdirSync(dist);
  _$jscoverage['feo.js'][37]++;
  fs.mkdirSync(dist);
});
_$jscoverage['feo.js'][40]++;
exports.optimizeScript = (function (config, window, callback) {
  _$jscoverage['feo.js'][41]++;
  var js = config.js || {}, compType = js.compressor || "yui-js", ignore = js.ignore || [], inline = js.inline === undefined? true: js.inline, root = js.root, dist = config.dist || "dist", $ = window.$, scripts = $("script").not((function () {
  _$jscoverage['feo.js'][50]++;
  var elem = $(this);
  _$jscoverage['feo.js'][51]++;
  return (this.src && ignore.indexOf(path.basename(this.src)) > -1)? true: ! this.src && $.trim(elem.text()) && ! inline? true: elem.data("feo") == "ignore"? true: this.type && this.type != "text/javascript"? true: false;
})).not(":last"), srcs = scripts.get(), htmlCharset = "utf8", that = this, log = config.log === undefined? true: config.log;
  _$jscoverage['feo.js'][62]++;
  log && console.log("Compaction scripts : ");
  _$jscoverage['feo.js'][63]++;
  async.map(srcs, (function (item, callback) {
  _$jscoverage['feo.js'][65]++;
  var src = item.src, type = item.type, charset = (item.charset || htmlCharset || "utf8").toLowerCase().replace(/-|_/g, ""), innerScript = $.trim($(item).text()), srcUrl;
  _$jscoverage['feo.js'][71]++;
  srcUrl = that.resolve(root, config.url, src);
  _$jscoverage['feo.js'][72]++;
  log && console.log("  " + (src? srcUrl: "inline"));
  _$jscoverage['feo.js'][73]++;
  if (! src && innerScript) {
    _$jscoverage['feo.js'][74]++;
    callback(null, innerScript);
    _$jscoverage['feo.js'][75]++;
    return;
  }
  _$jscoverage['feo.js'][78]++;
  that.load(srcUrl, config.proxy, "utf8", (function (err, body) {
  _$jscoverage['feo.js'][79]++;
  log && err && console.log(err);
  _$jscoverage['feo.js'][80]++;
  callback(null, body);
}));
}), (function (err, results) {
  _$jscoverage['feo.js'][85]++;
  var compressed = results.join(";\n");
  _$jscoverage['feo.js'][87]++;
  if (! config.suffix) {
    _$jscoverage['feo.js'][88]++;
    config.suffix = {};
  }
  _$jscoverage['feo.js'][90]++;
  config.suffix.js = crypto.createHash("md5").update(compressed).digest("hex");
  _$jscoverage['feo.js'][91]++;
  fs.writeFileSync(dist + "/feo." + config.suffix.js + ".unpack.js", compressed);
  _$jscoverage['feo.js'][92]++;
  new compressor.minify({type: compType, fileIn: dist + "/feo." + config.suffix.js + ".unpack.js", fileOut: dist + "/feo." + config.suffix.js + ".js", callback: (function (err) {
  _$jscoverage['feo.js'][97]++;
  log && err && console.log(err);
  _$jscoverage['feo.js'][98]++;
  scripts.remove();
  _$jscoverage['feo.js'][99]++;
  $("script.jsdom").remove();
  _$jscoverage['feo.js'][100]++;
  callback();
})});
}));
});
_$jscoverage['feo.js'][108]++;
exports.optimizeCss = (function (config, window, callback) {
  _$jscoverage['feo.js'][109]++;
  var css = config.css || {}, compType = css.compressor || "yui-css", ignore = css.ignore || [], inline = css.inline === undefined? true: css.inline, dist = config.dist, root = css.root, $ = window.$, links = $("link[href][rel=stylesheet],style").not((function () {
  _$jscoverage['feo.js'][118]++;
  var elem = $(this);
  _$jscoverage['feo.js'][119]++;
  return (this.href && ignore.indexOf(path.basename(this.href)) > -1)? true: ! this.href && $.trim(elem.text()) && ! inline? true: elem.data("feo") == "ignore"? true: false;
})), that = this, log = config.log === undefined? true: config.log;
  _$jscoverage['feo.js'][127]++;
  log && console.log("Compaction css : ");
  _$jscoverage['feo.js'][128]++;
  async.map(links.get(), (function (item, callback) {
  _$jscoverage['feo.js'][130]++;
  var href = item.href, innerStyle = $.trim($(item).text()), hrefUrl;
  _$jscoverage['feo.js'][134]++;
  hrefUrl = that.resolve(root, config.url, href);
  _$jscoverage['feo.js'][135]++;
  log && console.log("  " + (href? hrefUrl: "inline"));
  _$jscoverage['feo.js'][137]++;
  if (! href && innerStyle) {
    _$jscoverage['feo.js'][138]++;
    that.optimizeBackgroundImage(config, config.url, innerStyle, callback);
    _$jscoverage['feo.js'][139]++;
    return;
  }
  _$jscoverage['feo.js'][142]++;
  that.load(hrefUrl, config.proxy, "utf8", (function (err, body) {
  _$jscoverage['feo.js'][143]++;
  log && err && console.log(err);
  _$jscoverage['feo.js'][144]++;
  that.optimizeBackgroundImage(config, hrefUrl, body || "", callback);
}));
}), (function (err, results) {
  _$jscoverage['feo.js'][149]++;
  var compressed = results.join("\n");
  _$jscoverage['feo.js'][151]++;
  if (! config.suffix) {
    _$jscoverage['feo.js'][152]++;
    config.suffix = {};
  }
  _$jscoverage['feo.js'][154]++;
  config.suffix.css = crypto.createHash("md5").update(compressed).digest("hex");
  _$jscoverage['feo.js'][155]++;
  fs.writeFileSync(dist + "/feo." + config.suffix.css + ".unpack.css", compressed);
  _$jscoverage['feo.js'][156]++;
  new compressor.minify({type: compType, fileIn: dist + "/feo." + config.suffix.css + ".unpack.css", fileOut: dist + "/feo." + config.suffix.css + ".css", callback: (function (err) {
  _$jscoverage['feo.js'][161]++;
  log && err && console.log(err);
  _$jscoverage['feo.js'][162]++;
  links.remove();
  _$jscoverage['feo.js'][163]++;
  callback();
})});
}));
});
_$jscoverage['feo.js'][170]++;
exports.optimizeBackgroundImage = (function (config, href, body, callback) {
  _$jscoverage['feo.js'][171]++;
  var css = config.css || {}, root = css.root, backgroundImages = (body.match(/url\([^\)]+\)/g) || []).map((function (str) {
  _$jscoverage['feo.js'][174]++;
  str = str.replace(/[\"\']/g, "");
  _$jscoverage['feo.js'][175]++;
  if (! /\.(jpg|gif|png|bmp)\)$/i.test(str)) {
    _$jscoverage['feo.js'][176]++;
    return "";
  }
  _$jscoverage['feo.js'][178]++;
  return str.match(/\(([^\)]+)\)/)[1];
})), that = this, log = config.log === undefined? true: config.log;
  _$jscoverage['feo.js'][183]++;
  log && console.log("Optimizing background-image :");
  _$jscoverage['feo.js'][184]++;
  async.map(backgroundImages, (function (item, callback) {
  _$jscoverage['feo.js'][185]++;
  var imageUrl;
  _$jscoverage['feo.js'][187]++;
  if (! item) {
    _$jscoverage['feo.js'][188]++;
    callback();
    _$jscoverage['feo.js'][189]++;
    return;
  }
  _$jscoverage['feo.js'][191]++;
  imageUrl = that.resolve(root, href, item);
  _$jscoverage['feo.js'][192]++;
  log && console.log("  " + imageUrl);
  _$jscoverage['feo.js'][194]++;
  that.load(imageUrl, config.proxy, "binary", (function (err, bgBody) {
  _$jscoverage['feo.js'][195]++;
  log && err && console.log(err);
  _$jscoverage['feo.js'][196]++;
  var ext = item.match(/\.([^.]+)$/)[1], reg = new RegExp("url\\([\\'\\\"]?" + item + "[\\'\\\"]?\\)", "g");
  _$jscoverage['feo.js'][198]++;
  if (bgBody) {
    _$jscoverage['feo.js'][198]++;
    body = body.replace(reg, "url(data:image/" + ext + ";base64," + new Buffer(bgBody, "binary").toString("base64") + ")");
  }
  _$jscoverage['feo.js'][199]++;
  callback();
}));
}), (function (err, results) {
  _$jscoverage['feo.js'][203]++;
  callback(null, body);
}));
});
_$jscoverage['feo.js'][207]++;
exports.optimizeImage = (function (config, window, callback) {
  _$jscoverage['feo.js'][208]++;
  var image = config.image || {}, ignore = image.ignore || [], $ = window.$, root = image.root, imgs = $("img[src]").not((function () {
  _$jscoverage['feo.js'][214]++;
  var elem = $(this);
  _$jscoverage['feo.js'][215]++;
  return ignore.indexOf(path.basename(this.href)) > -1? true: elem.data("feo") == "ignore"? true: false;
})), that = this, log = config.log === undefined? true: config.log;
  _$jscoverage['feo.js'][221]++;
  log && console.log("Optimizing image : ");
  _$jscoverage['feo.js'][222]++;
  async.map(imgs.get(), (function (item, callback) {
  _$jscoverage['feo.js'][224]++;
  var src = item.src, ext = (src.match(/\.([^.]+)$/) || [])[1], imageUrl;
  _$jscoverage['feo.js'][228]++;
  if (! src || ! /^(jpg|gif|png|bmp)$/i.test(ext)) {
    _$jscoverage['feo.js'][229]++;
    callback();
    _$jscoverage['feo.js'][230]++;
    return;
  }
  _$jscoverage['feo.js'][232]++;
  imageUrl = that.resolve(root, config.url, src);
  _$jscoverage['feo.js'][233]++;
  log && console.log("  " + imageUrl);
  _$jscoverage['feo.js'][235]++;
  that.load(imageUrl, config.proxy, "binary", (function (err, body) {
  _$jscoverage['feo.js'][236]++;
  if (body) {
    _$jscoverage['feo.js'][236]++;
    item.src = "data:image/" + ext + ";base64," + new Buffer(body, "binary").toString("base64");
  }
  _$jscoverage['feo.js'][237]++;
  callback();
}));
}), (function (err, results) {
  _$jscoverage['feo.js'][242]++;
  callback();
}));
});
_$jscoverage['feo.js'][247]++;
exports.optimizeHtml = (function (config, window, callback) {
  _$jscoverage['feo.js'][248]++;
  var $ = window.$, dist = config.dist, html, basename, log = config.log === undefined? true: config.log;
  _$jscoverage['feo.js'][254]++;
  log && console.log("Optimize HTML");
  _$jscoverage['feo.js'][255]++;
  $("head").append("<link type=\"text/css\" rel=\"stylesheet\" href=\"feo." + config.suffix.css + ".css\" >");
  _$jscoverage['feo.js'][256]++;
  html = "<!DOCTYPE html>\n<html>" + $("html").html() + "\n<script charset=\"utf-8\" src=\"feo." + config.suffix.js + ".js\" type=\"text/javascript\" ></script>\n</html>";
  _$jscoverage['feo.js'][258]++;
  basename = this.isLocal(config.url)? path.basename(config.url, ".html"): config.url.replace(/\.html$/, "").split("/").pop() || "index";
  _$jscoverage['feo.js'][259]++;
  fs.writeFileSync(dist + "/" + basename + ".unpack.html", html);
  _$jscoverage['feo.js'][260]++;
  fs.writeFileSync(dist + "/" + basename + ".html", htmlMinifier.minify(html, {removeComments: true, collapseWhitespace: true}));
  _$jscoverage['feo.js'][264]++;
  callback();
});
_$jscoverage['feo.js'][267]++;
exports.load = (function (url, proxy, encoding, callback) {
  _$jscoverage['feo.js'][268]++;
  this.isLocal(url)? fs.readFile(url, encoding || "utf8", (function (err, body) {
  _$jscoverage['feo.js'][270]++;
  callback(err, body);
})): request({uri: url, encoding: encoding || "utf8", proxy: proxy || null}, (function (err, request, body) {
  _$jscoverage['feo.js'][277]++;
  callback(err, body);
}));
});
_$jscoverage['feo.js'][282]++;
exports.optimize = (function (config, callback) {
  _$jscoverage['feo.js'][283]++;
  var that = this, log = config.log === undefined? true: config.log;
  _$jscoverage['feo.js'][286]++;
  log && console.log("Target : ");
  _$jscoverage['feo.js'][287]++;
  log && console.log("  " + config.url);
  _$jscoverage['feo.js'][290]++;
  this.load(config.url, config.proxy, "utf8", (function (err, body) {
  _$jscoverage['feo.js'][291]++;
  jsdom.env({html: body, src: [fs.readFileSync("./lib/jquery-1.8.0.min.js", "utf8").toString()], done: (function (errors, window) {
  _$jscoverage['feo.js'][297]++;
  var $ = window.$, htmlCharset = (($("meta[content*=charset]").attr("content") || "").match(/charset=([^;]+)/) || [])[1] || window.document.charset || "utf8";
  _$jscoverage['feo.js'][299]++;
  async.waterfall([(function (callback) {
  _$jscoverage['feo.js'][300]++;
  that.optimizeScript(config, window, callback);
}), (function (callback) {
  _$jscoverage['feo.js'][302]++;
  that.optimizeCss(config, window, callback);
}), (function (callback) {
  _$jscoverage['feo.js'][304]++;
  that.optimizeImage(config, window, callback);
}), (function (callback) {
  _$jscoverage['feo.js'][306]++;
  that.optimizeHtml(config, window, callback);
})], (function () {
  _$jscoverage['feo.js'][308]++;
  callback();
}));
})});
}));
});
_$jscoverage['feo.js'][316]++;
exports.cli = (function (config) {
  _$jscoverage['feo.js'][317]++;
  var that = this, log = config.log === undefined? true: config.log;
  _$jscoverage['feo.js'][320]++;
  this.init(config);
  _$jscoverage['feo.js'][322]++;
  if (this.isLocal(config.url) && fs.statSync(config.url).isDirectory()) {
    _$jscoverage['feo.js'][323]++;
    fs.existFileSync && wrench.rmdirSyncRecursive(config.dist);
    _$jscoverage['feo.js'][324]++;
    wrench.copyDirSyncRecursive(config.url, config.dist);
    _$jscoverage['feo.js'][325]++;
    async.map(wrench.readdirSyncRecursive(config.dist).filter((function (val) {
  _$jscoverage['feo.js'][327]++;
  return /\.html/.test(val);
})), (function (item, callback) {
  _$jscoverage['feo.js'][330]++;
  var target = _.clone(config);
  _$jscoverage['feo.js'][332]++;
  target.url = path.resolve(config.dist, item);
  _$jscoverage['feo.js'][333]++;
  target.dist = path.dirname(path.resolve(config.dist, item));
  _$jscoverage['feo.js'][334]++;
  target.suffix = target.suffix || {};
  _$jscoverage['feo.js'][335]++;
  that.optimize(target, callback);
}), (function (err, results) {
  _$jscoverage['feo.js'][338]++;
  log && console.log("Finished!!");
}));
  }
  else {
    _$jscoverage['feo.js'][342]++;
    config.suffix = config.suffix || {};
    _$jscoverage['feo.js'][343]++;
    that.optimize(config, (function () {
  _$jscoverage['feo.js'][344]++;
  log && console.log("Finished!!");
}));
  }
});
_$jscoverage['feo.js'].source = ["","var jsdom = require('jsdom'),","  async = require('async'),","  request = require('request'),","  fs = require('fs'),","  path = require('path'),","  compressor = require('node-minify'),","  htmlMinifier = require('html-minifier'),","  crypto = require('crypto'),","  url = require('url'),","  wrench = require('wrench'),","  _ = require('underscore');","","","exports.isLocal = function( target ){","  return /^http/.test( target ) ? false : true;","}","","exports.resolve = function( root, base, target ){","  if(this.isLocal(base)){","    return !this.isLocal(target) ? url.resolve( base, target ) : ","            /^\\//.test( target ) ? path.join( root, target ) :","                                   path.resolve( path.dirname( base ), target );","  } else {","    return  url.resolve(base, target);","  }","}","","exports.init = function( config ){","  var dist = config.dist,","      distFiles = [],","      i,","      log = config.log === undefined ? true : config.log;","  log &amp;&amp; console.log(\"Cleaning dist : \");","  log &amp;&amp; console.log(\"  \"+dist);","  fs.existsSync(dist) &amp;&amp; wrench.rmdirSyncRecursive(dist) &amp;&amp; fs.rmdirSync( dist );","  fs.mkdirSync(dist);","}","","exports.optimizeScript = function( config, window, callback){","  var js = config.js || {},","      compType = js.compressor || 'yui-js',","      ignore = js.ignore || [],","      inline = js.inline === undefined ? true : js.inline,","      root = js.root,","      dist = config.dist || 'dist',","      $ = window.$,","      scripts = $('script')","                .not(function(){","                  var elem = $(this);","                  return (this.src &amp;&amp; ignore.indexOf( path.basename( this.src ) ) &gt; -1) ? true : ","                         !this.src &amp;&amp; $.trim( elem.text() ) &amp;&amp; !inline ? true : ","                         elem.data(\"feo\") == \"ignore\" ? true : ","                         this.type &amp;&amp; this.type != \"text/javascript\" ? true : false;","","                }).not(':last'),","      srcs = scripts.get(),","      htmlCharset = 'utf8',","      that = this,","      log = config.log === undefined ? true : config.log;","","  log &amp;&amp; console.log(\"Compaction scripts : \");","  async.map(srcs,","    function(item, callback){","      var src = item.src,","          type = item.type,","          charset = ( item.charset || htmlCharset || 'utf8' ).toLowerCase().replace(/-|_/g,''),","          innerScript = $.trim( $(item).text() ),","          srcUrl;","","      srcUrl = that.resolve( root, config.url, src );","      log &amp;&amp; console.log(\"  \"+(src ? srcUrl : \"inline\"));","      if( !src &amp;&amp; innerScript){","        callback(null, innerScript);","        return;","      }","","      that.load(srcUrl, config.proxy, 'utf8', function(err, body){","          log &amp;&amp; err &amp;&amp; console.log(err);","          callback( null, body );","      });","","    },","    function(err, results){","      var compressed = results.join(';\\n');","","      if(!config.suffix) {","        config.suffix = {};","      }","      config.suffix.js = crypto.createHash('md5').update(compressed).digest('hex');","      fs.writeFileSync(dist+'/feo.'+config.suffix.js+'.unpack.js', compressed);","      new compressor.minify({","        type: compType,","        fileIn: dist+'/feo.'+config.suffix.js+'.unpack.js',","        fileOut: dist+'/feo.'+config.suffix.js+'.js',","        callback: function(err){","          log &amp;&amp; err &amp;&amp; console.log(err);","          scripts.remove();","          $('script.jsdom').remove();","          callback();","        }","      });","    }","  );","","}","","exports.optimizeCss = function(config, window, callback){","  var css = config.css || {},","      compType = css.compressor  || 'yui-css',","      ignore = css.ignore || [],","      inline = css.inline === undefined ? true : css.inline,","      dist = config.dist,","      root = css.root,","      $ = window.$,","      links = $('link[href][rel=stylesheet],style')","          .not(function(){","              var elem = $(this);","              return (this.href &amp;&amp; ignore.indexOf( path.basename( this.href ) ) &gt; -1) ? true : ","                     !this.href &amp;&amp; $.trim( elem.text() ) &amp;&amp; !inline ? true : ","                     elem.data(\"feo\") == \"ignore\" ? true : false;","          }),","      that = this,","      log = config.log === undefined ? true : config.log;","","","  log &amp;&amp; console.log(\"Compaction css : \");","  async.map(links.get(),","    function(item, callback){","      var href = item.href,","          innerStyle = $.trim( $(item).text() ),","          hrefUrl;","","      hrefUrl = that.resolve( root, config.url, href );","      log &amp;&amp; console.log(\"  \"+ (href ? hrefUrl : \"inline\"));","","      if( !href &amp;&amp; innerStyle){","        that.optimizeBackgroundImage( config, config.url, innerStyle, callback );","        return;","      }","","      that.load(hrefUrl, config.proxy, 'utf8', function(err, body){","          log &amp;&amp; err &amp;&amp; console.log(err);","          that.optimizeBackgroundImage( config, hrefUrl, body || '', callback );","      });","","    },","    function(err, results){","      var compressed = results.join('\\n');","","      if(!config.suffix) {","        config.suffix = {};","      }","      config.suffix.css = crypto.createHash('md5').update(compressed).digest('hex');","      fs.writeFileSync(dist+'/feo.'+config.suffix.css+'.unpack.css', compressed);","      new compressor.minify({","        type: compType,","        fileIn: dist+'/feo.'+config.suffix.css+'.unpack.css',","        fileOut: dist+'/feo.'+config.suffix.css+'.css',","        callback: function(err){","          log &amp;&amp; err &amp;&amp; console.log(err);","          links.remove();","          callback();","        }","      });","    }","  );","}","","exports.optimizeBackgroundImage = function( config, href, body, callback){","  var css = config.css || {},","      root = css.root,","      backgroundImages = (body.match(/url\\([^\\)]+\\)/g)||[]).map(function(str){","        str = str.replace(/[\\\"\\']/g,'');","        if(!/\\.(jpg|gif|png|bmp)\\)$/i.test(str)){","          return \"\";","        }","        return str.match(/\\(([^\\)]+)\\)/)[1];","      }),","      that = this,","      log = config.log === undefined ? true : config.log;","","  log &amp;&amp; console.log(\"Optimizing background-image :\");","  async.map(backgroundImages, function(item, callback){","    var imageUrl;","","    if(!item){","      callback();","      return;","    }","    imageUrl = that.resolve( root, href, item );","    log &amp;&amp; console.log(\"  \"+ imageUrl);","","    that.load( imageUrl, config.proxy, 'binary', function(err, bgBody){","        log &amp;&amp; err &amp;&amp; console.log(err);","        var ext = item.match(/\\.([^.]+)$/)[1],","            reg = new RegExp(\"url\\\\([\\\\'\\\\\\\"]?\"+item+\"[\\\\'\\\\\\\"]?\\\\)\", \"g\"); ","        if(bgBody) body = body.replace(reg, \"url(data:image/\"+ext+\";base64,\"+(new Buffer(bgBody, 'binary').toString('base64'))+\")\");","        callback();","    });","","  }, function(err, results){","    callback( null, body );","  });","}","","exports.optimizeImage = function( config, window, callback ){","  var image = config.image || {},","      ignore = image.ignore || [],","      $ = window.$,","      root = image.root,","      imgs = $('img[src]')","          .not(function(){","              var elem = $(this);","              return ignore.indexOf( path.basename( this.href ) ) &gt; -1 ? true : ","                     elem.data(\"feo\") == \"ignore\" ? true : false;","          }),","      that = this,","      log = config.log === undefined ? true : config.log;","","  log &amp;&amp; console.log(\"Optimizing image : \");","  async.map(imgs.get(),","    function(item, callback){","      var src = item.src,","          ext = (src.match(/\\.([^.]+)$/)||[])[1],","          imageUrl;","","      if(!src || !/^(jpg|gif|png|bmp)$/i.test(ext)){","        callback();","        return;","      }","      imageUrl = that.resolve( root, config.url, src );","      log &amp;&amp; console.log(\"  \"+ imageUrl);","","      that.load(imageUrl, config.proxy, 'binary', function(err, body){","          if(body) item.src = \"data:image/\"+ext+\";base64,\"+(new Buffer(body, 'binary').toString('base64'));","          callback();","      });","","    },","    function(err, results){","        callback();","    }","  );","}","","exports.optimizeHtml = function( config, window, callback ){","  var $ = window.$,","      dist = config.dist,","      html,","      basename,","      log = config.log === undefined ? true : config.log;","","  log &amp;&amp; console.log(\"Optimize HTML\");","  $('head').append('&lt;link type=\"text/css\" rel=\"stylesheet\" href=\"feo.'+config.suffix.css+'.css\" &gt;');","  html = '&lt;!DOCTYPE html&gt;\\n&lt;html&gt;'+$('html').html()+'\\n&lt;script charset=\"utf-8\" src=\"feo.'+config.suffix.js+'.js\" type=\"text/javascript\" &gt;&lt;/script&gt;\\n&lt;/html&gt;';","","  basename = this.isLocal(config.url) ? path.basename(config.url, '.html') : config.url.replace(/\\.html$/,'').split(\"/\").pop() || 'index';","  fs.writeFileSync(dist+'/'+basename+'.unpack.html', html);","  fs.writeFileSync(dist+'/'+basename+'.html', htmlMinifier.minify(html,{","    removeComments: true,","    collapseWhitespace: true","  }));","  callback();","}","","exports.load = function( url, proxy, encoding, callback ){","  this.isLocal(url) ?","    fs.readFile( url, encoding || 'utf8', function(err, body){","      callback(err, body);","    }) ","  : request({","        uri : url,","        encoding : encoding || 'utf8',","        proxy : proxy || null","      }, function(err, request, body){","        callback(err, body);","      }","    );","}","","exports.optimize = function(config, callback ){","  var that = this,","      log = config.log === undefined ? true : config.log;","","  log &amp;&amp; console.log(\"Target : \");","  log &amp;&amp; console.log(\"  \"+config.url);","","","  this.load(config.url, config.proxy, 'utf8', function(err, body){","    jsdom.env({","      html: body,","      src: [","        fs.readFileSync('./lib/jquery-1.8.0.min.js', 'utf8').toString()","      ],","      done: function(errors, window) {","        var $ = window.$,","            htmlCharset = (($('meta[content*=charset]').attr('content')||'').match(/charset=([^;]+)/)||[])[1]||window.document.charset||'utf8'; ","        async.waterfall([function(callback){","          that.optimizeScript( config, window, callback );","        },function(callback){","          that.optimizeCss( config, window, callback );","        },function(callback){","          that.optimizeImage( config, window, callback );","        },function(callback){","          that.optimizeHtml( config, window, callback );","        }],function(){","          callback();","        });      ","      }","    });","  });","","}","","exports.cli = function( config ){","    var that = this,","        log = config.log === undefined ? true : config.log;","","    this.init( config );","","    if( this.isLocal(config.url) &amp;&amp; fs.statSync(config.url).isDirectory() ){","      fs.existFileSync &amp;&amp; wrench.rmdirSyncRecursive(config.dist);","      wrench.copyDirSyncRecursive(config.url, config.dist);","      async.map(","        wrench.readdirSyncRecursive(config.dist).filter(function(val){","          return /\\.html/.test( val );","        }),","        function( item, callback ){","          var target = _.clone(config);","","          target.url = path.resolve( config.dist, item );","          target.dist = path.dirname( path.resolve( config.dist, item ) );","          target.suffix = target.suffix || {};","          that.optimize( target, callback);","        },","        function(err, results ){","          log &amp;&amp; console.log(\"Finished!!\");","        }","      );","    } else {","      config.suffix = config.suffix || {};","      that.optimize( config, function(){","        log &amp;&amp; console.log(\"Finished!!\");","      });","    }","}"];
